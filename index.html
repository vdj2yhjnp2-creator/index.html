<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¹ Drink Pocket</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getDatabase, ref, onValue, set } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDq0z0XzL3kL9z5qZ7xY8w9vT2uR4sQ6pM",
            authDomain: "drink-pocket-sync.firebaseapp.com",
            databaseURL: "https://drink-pocket-sync-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "drink-pocket-sync",
            storageBucket: "drink-pocket-sync.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const drinksRef = ref(db, 'drinks');
        
        window.dbReady = true;
        window.drinksRef = drinksRef;
        window.setDrinks = set;
        window.onValue = onValue;
    </script>
    <style>
        body{font-family:system-ui,max-width:600px;margin:0 auto;padding:20px;background:#f8f9fa}
        input,button{padding:12px;margin:8px 0;width:100%;box-sizing:border-box;border:1px solid #ddd;border-radius:8px;font-size:16px}
        button{background:#007bff;color:white;border:none;cursor:pointer}
        button:hover{background:#0056b3}
        .drink{background:#fff;padding:20px;margin:12px 0;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
        .drink h3{margin:0 0 10px;font-size:1.3em}
        .search{background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:15px}
        #lista{min-height:200px}
        small{color:#666}
        .status{padding:10px;border-radius:5px;margin:10px 0}
        .ok{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
        .error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    </style>
</head>
<body>
    <h1>ğŸ¹ Drink Pocket</h1>
    <div id="status" class="status">Caricamento Firebase...</div>
    
    <div class="search">
        <input type="text" id="cerca" placeholder="ğŸ” Cerca drink..." oninput="filtra()">
    </div>
    
    <button onclick="nuovo()">+ Nuovo Drink</button>
    <div id="lista"></div>
    
    <div style="margin-top:30px;padding-top:20px;border-top:1px solid #eee">
        <button onclick="testSync()">ğŸ§ª Test Sincronizzazione</button>
        <button onclick="esporta()">ğŸ“¤ Backup</button>
        <input type="file" id="importa" accept=".json" onchange="importa(event)" style="display:none">
        <button onclick="document.getElementById('importa').click()">ğŸ“¥ Ripristina</button>
    </div>

    <script>
        let drinks = [];
        
        // Test Firebase
        if(window.dbReady) {
            document.getElementById('status').innerHTML = 'âœ… Firebase OK - Sincronizzazione attiva';
            document.getElementById('status').className = 'status ok';
            
            onValue(window.drinksRef, (snap) => {
                drinks = snap.val() ? Object.values(snap.val()) : [];
                aggiornaLista();
            });
        } else {
            document.getElementById('status').innerHTML = 'âŒ Firebase non caricato - Usa esporta/importa';
            document.getElementById('status').className = 'status error';
        }
        
        function salva() {
            if(window.dbReady) {
                const data = {};
                drinks.forEach((d,i) => data[i] = d);
                window.setDrinks(window.drinksRef, data);
            }
        }
        
        function testSync() {
            drinks.push({
                nome: 'TEST ' + new Date().toLocaleTimeString(),
                data: 'Sync OK',
                ingredienti: 'Aperto da: ' + navigator.userAgent.slice(0,50)
            });
            salva();
            alert('Test aggiunto! Controlla l\'altro dispositivo!');
        }
        
        function nuovo() {
            const nome = prompt("Nome drink:");
            if(nome && window.dbReady) {
                drinks.push({
                    nome, ingredienti:"", istruzioni:"", 
                    data: new Date().toLocaleDateString('it-IT')
                });
                salva();
            } else if(!window.dbReady) {
                alert('Firebase non funziona, usa esporta/importa');
            }
        }
        
        function filtra() {
            const q = document.getElementById('cerca').value.toLowerCase();
            document.getElementById('lista').innerHTML = 
                drinks.filter(d=>d.nome.toLowerCase().includes(q))
                      .map((d,i)=>drinkHTML(d,i)).join('');
        }
        
        function aggiornaLista() { filtra(); }
        
        function drinkHTML(drink, i) {
            return `<div class="drink">
                <h3>${drink.nome}</h3>
                <p><strong>ğŸ¥ƒ Ingredienti:</strong> ${drink.ingredienti||'â€”'}</p>
                <p><strong>ğŸ“ Istruzioni:</strong> ${drink.istruzioni||'â€”'}</p>
                <small>âœ¨ ${drink.data}</small>
                <br><br>
                <button onclick="mod(${i})" style="background:#28a745;width:48%;margin-right:4%">âœï¸</button>
                <button onclick="elim(${i})" style="background:#dc3545;width:48%">ğŸ—‘ï¸</button>
            </div>`;
        }
        
        function mod(i) {
            const d = drinks[i];
            d.nome = prompt("Nome:", d.nome)||d.nome;
            d.ingredienti = prompt("Ingredienti:", d.ingredienti)||d.ingredienti;
            d.istruzioni = prompt("Istruzioni:", d.istruzioni)||d.istruzioni;
            d.data = new Date().toLocaleDateString('it-IT');
            salva();
        }
        
        function elim(i) {
            if(confirm("Eliminare?")) {
                drinks.splice(i,1);
                salva();
            }
        }
        
        function esporta() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(drinks,null,2)],{type:'application/json'}));
            a.download = 'drinks.json';
            a.click();
        }
        
        function importa(e) {
            const file = e.target.files[0];
            const r = new FileReader();
            r.onload = ev => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if(confirm("Sovrascrivere?")) {
                        drinks = data;
                        salva();
                    }
                } catch { alert("File non valido"); }
            };
            r.readAsText(file);
        }
    </script>
</body>
</html>
